<UserControl x:Class="PointlessWaymarks.GeoTaggingGui.FileBasedTaggerControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:PointlessWaymarks.GeoTaggingGui"
             xmlns:numericUpDownLib="clr-namespace:NumericUpDownLib;assembly=NumericUpDownLib"
             xmlns:b="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:wpf="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
             xmlns:wpfHtml="clr-namespace:PointlessWaymarks.WpfCommon.WpfHtml;assembly=PointlessWaymarks.WpfCommon"
             xmlns:valueConverters="clr-namespace:PointlessWaymarks.WpfCommon.ValueConverters;assembly=PointlessWaymarks.WpfCommon"
             xmlns:behaviors="clr-namespace:PointlessWaymarks.WpfCommon.Behaviors;assembly=PointlessWaymarks.WpfCommon"
             xmlns:utility="clr-namespace:PointlessWaymarks.WpfCommon.Utility;assembly=PointlessWaymarks.WpfCommon"
             mc:Ignorable="d"
             d:DesignHeight="450" d:DesignWidth="800"
             d:DataContext="{d:DesignInstance local:FileBasedTaggerContext}">
    <UserControl.Resources>
        <ResourceDictionary>
            <valueConverters:BooleanNotToVisibilityConverter x:Key="BooleanNotToVisibility" />
            <utility:BindingProxy x:Key="Proxy" Data="{Binding}" />
        </ResourceDictionary>
    </UserControl.Resources>
    <Grid>
        <TabControl>
            <TabItem Header="GPX Files">
                <Grid Margin="4">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"></RowDefinition>
                        <RowDefinition Height="*"></RowDefinition>
                    </Grid.RowDefinitions>
                    <GroupBox Header="Add">
                        <StackPanel>
                            <TextBlock TextWrapping="Wrap">Use the buttons below to add all files in a Directory, all files in a Directory and all Subdirectories or to pick Files to add to the GPX files that location information will be taken from. You can also delete items in the list below.</TextBlock>
                            <WrapPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,8,0,8">
                                <WrapPanel.Resources>
                                    <Style TargetType="Button">
                                        <Setter Property="Width" Value="180" />
                                    </Style>
                                </WrapPanel.Resources>
                                <Button Command="{Binding AddGpxFilesFromDirectoryCommand}">Directory</Button>
                                <Button Command="{Binding AddGpxFilesFromDirectoryAndSubdirectoriesCommand }">Directory with Subdirectories</Button>
                                <Button Command="{Binding AddGpxFilesCommand}">Files</Button>
                            </WrapPanel>
                        </StackPanel>
                    </GroupBox>
                    <GroupBox Header="GPX Files - Location Data" Grid.Row="1">
                        <DataGrid Margin="2" ItemsSource="{Binding GpxFiles}" CanUserAddRows="False"
                                  CanUserReorderColumns="true"
                                  CanUserDeleteRows="true" CanUserResizeColumns="true" CanUserResizeRows="False"
                                  CanUserSortColumns="true" AutoGenerateColumns="False" IsReadOnly="True" behaviors:MultiSelectorBehaviours.SynchronizedSelectedItems="{Binding GpxFilesSelected}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Width="*" Header="File" Binding="{Binding FullName}" />
                            </DataGrid.Columns>
                        </DataGrid>
                    </GroupBox>
                </Grid>
            </TabItem>
            <TabItem Header="Files To Tag">
                <Grid Margin="4">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"></RowDefinition>
                        <RowDefinition Height="*"></RowDefinition>
                    </Grid.RowDefinitions>
                    <GroupBox Header="Add">
                        <StackPanel>
                            <TextBlock TextWrapping="Wrap">Use the buttons below to add all files in a Directory, all files in a Directory and all Subdirectories or to pick Files that will be compared to the GPX/location information in the previous tab. You can also delete items in the list below.</TextBlock>
                            <WrapPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,8,0,8">
                                <WrapPanel.Resources>
                                    <Style TargetType="Button">
                                        <Setter Property="Width" Value="180" />
                                    </Style>
                                </WrapPanel.Resources>
                                <Button Command="{Binding AddFilesToTagFromDirectoryCommand}">Directory</Button>
                                <Button Command="{Binding AddFilesToTagFromDirectoryAndSubdirectoriesCommand }">Directory with Subdirectories</Button>
                                <Button Command="{Binding AddFilesToTagCommand}">Files</Button>
                            </WrapPanel>
                        </StackPanel>
                    </GroupBox>
                    <GroupBox Grid.Row="1" Header="Files To Tag">
                        <DataGrid Margin="2" ItemsSource="{Binding FilesToTag}" CanUserAddRows="False"
                                  CanUserReorderColumns="true"
                                  CanUserDeleteRows="true" CanUserResizeColumns="true" CanUserResizeRows="False"
                                  CanUserSortColumns="true" AutoGenerateColumns="False" IsReadOnly="True" behaviors:MultiSelectorBehaviours.SynchronizedSelectedItems="{Binding FilesToTagSelected}">
                            <DataGrid.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Command="{Binding MetadataForSelectedFilesToTagCommand}" Header="Metadata Report for Selected"></MenuItem>
                                </ContextMenu>
                            </DataGrid.ContextMenu>
                            <DataGrid.Columns>
                                <DataGridTextColumn Width="*" Header="File" Binding="{Binding FullName}" />
                            </DataGrid.Columns>
                        </DataGrid>
                    </GroupBox>
                </Grid>
            </TabItem>
            <TabItem Header="GeoTagging Settings">
                <StackPanel>
                    <GroupBox Header="ExifTool">
                        <StackPanel Orientation="Vertical">
                            <TextBox Text="{Binding ExifToolFullName, UpdateSourceTrigger=PropertyChanged}" />
                            <TextBlock TextWrapping="Wrap" Margin="4">This program can write to a wider variety of file formats by using Phil Harvey's ExifTool - https://exiftool.org/. The recommended version of the program can be downloaded from https://oliverbetz.de/pages/Artikel/ExifTool-for-Windows - you must provide the full path and filename above for the program to use ExifTool.</TextBlock>
                        </StackPanel>
                    </GroupBox>
                    <GroupBox Header="Tag">
                        <StackPanel Orientation="Vertical">
                            <StackPanel Orientation="Vertical" Margin="4">
                                <StackPanel.Resources>
                                    <Style TargetType="CheckBox">
                                        <Setter Property="Margin" Value="4,8,4,4"></Setter>
                                    </Style>
                                </StackPanel.Resources>
                                <StackPanel Orientation="Vertical">
                                    <CheckBox IsChecked="{Binding CreateBackups}">Create Backups</CheckBox>
                                    <TextBlock Margin="12,0,4,4" TextWrapping="Wrap">When Geolocation information is found for a file the original version will be copied into a backup directory.</TextBlock>
                                </StackPanel>
                                <StackPanel Orientation="Vertical">
                                    <CheckBox IsChecked="{Binding OverwriteExistingGeoLocation}">Overwrite Existing Geolocation</CheckBox>
                                    <TextBlock Margin="12,0,4,4" TextWrapping="Wrap">If checked any existing Geolocation Metadata will be overwritten if a location is found.</TextBlock>
                                </StackPanel>
                                <StackPanel Orientation="Vertical">
                                    <CheckBox IsChecked="{Binding TestRunOnly}">Test Run Only</CheckBox>
                                    <TextBlock Margin="12,0,4,4" TextWrapping="Wrap">Results will be shown but NO Geolocation will be written, use this to see what changes the program would make without changing any files.</TextBlock>
                                </StackPanel>
                                <GroupBox Header="File Time Must Be Within Minutes of Point" Margin="0,4,4,4">
                                    <StackPanel Orientation="Vertical">
                                        <numericUpDownLib:ShortUpDown HorizontalAlignment="Left" Margin="4,6,4,4"
                                                                      Value="{Binding PointsMustBeWithinMinutes}" />
                                        <TextBlock TextWrapping="Wrap" Margin="4">File Time must be Within Minutes of Point - The program will look for points with the specified number of minutes - too large a value risks associating points with a location that doesn't make sense, too small and points sparse track may be missed.</TextBlock>
                                    </StackPanel>
                                </GroupBox>
                                <GroupBox Header="Adjust File Time by Minutes" Margin="0,4,4,4">
                                    <StackPanel Orientation="Vertical" Margin="4,6,4,4">
                                        <numericUpDownLib:ShortUpDown HorizontalAlignment="Left"  Value="{Binding OffsetPhotoTimeInMinutes}" />
                                        <TextBlock TextWrapping="Wrap" Margin="4">Adjust File Time by Minutes - File times for photographs and other files can be created by devices that don't have accurate clocks - use this setting if you know that the created time for a file is offset by a consistent number of minutes (positive or negative).</TextBlock>
                                    </StackPanel>
                                </GroupBox>
                            </StackPanel>
                            <Button Command="{Binding TagCommand}" Height="40" Margin="8">Tag</Button>
                        </StackPanel>
                    </GroupBox>

                </StackPanel>
            </TabItem>
            <TabItem Header="Result">
                <GroupBox Header="Tag Result">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"></RowDefinition>
                            <RowDefinition Height="Auto"></RowDefinition>
                            <RowDefinition Height="*"></RowDefinition>
                        </Grid.RowDefinitions>
                        <TextBox IsReadOnly="true" TextWrapping="Wrap"
                                 Text="{Binding LastTagOutput.Title, FallbackValue='No Results Generated'}" />
                        <TextBox Grid.Row="1"  IsReadOnly="true" TextWrapping="Wrap"
                                 Text="{Binding LastTagOutput.Notes, FallbackValue=''}" />
                        <DataGrid Grid.Row="2"  ItemsSource="{Binding LastTagOutput.FileResults}" CanUserAddRows="False"
                                  CanUserReorderColumns="true"
                                  CanUserDeleteRows="false" CanUserResizeColumns="true" CanUserResizeRows="false"
                                  CanUserSortColumns="true" AutoGenerateColumns="true" />
                    </Grid>
                </GroupBox>
            </TabItem>
            <TabItem Header="Result Map">
                <wpf:WebView2 Grid.Row="1" Visibility="{Binding StatusContext.BlockUi, Converter={StaticResource BooleanNotToVisibility}}">
                    <b:Interaction.Behaviors>
                        <wpfHtml:WebViewHtmlStringBindingBehavior HtmlString="{Binding PreviewHtml}" />
                        <wpfHtml:WebViewPostJsonOnChangeBehavior JsonData="{Binding PreviewGeoJsonDto}" />
                    </b:Interaction.Behaviors>
                </wpf:WebView2>
            </TabItem>
        </TabControl>
    </Grid>
</UserControl>